---
  # backup-setup.yml
  - name: Configure Backup Server
    hosts: linux
    become: yes
    vars:
      backup_dir: /mnt/backup/linux
  
    tasks:
      - name: Create backup user
        user:
          name: backuper
          password: "{{ 'kali' | password_hash('sha512') }}"
          shell: /bin/bash
  
      - name: Create backup directory
        file:
          path: "{{ backup_dir }}"
          state: directory
          owner: backuper
          group: backuper
          mode: '0755'
  
      - name: Allow SSH password login (tempor√§r)
        lineinfile:
          path: /etc/ssh/sshd_config
          regexp: "^PasswordAuthentication"
          line: "PasswordAuthentication yes"
          state: present
        notify: restart ssh
  
    handlers:
      - name: restart ssh
        service:
          name: ssh
          state: restarted
  
  - name: Configure Clients
    hosts: linux_hosts
    become: yes
    vars:
      backup_server_ip: "192.168.72.131"  # Hier anpassen!
      backup_user: backuper
  
    tasks:
      - name: Install BorgBackup
        apt:
          name: borgbackup
          state: present
          update_cache: yes
  
      - name: Create SSH keypair
        user:
          name: kali
          generate_ssh_key: yes
          ssh_key_bits: 2048
          ssh_key_file: .ssh/id_borg
  
      - name: Copy public key to backup server
        authorized_key:
          user: backuper
          state: present
          key: "{{ lookup('file', '/home/kali/.ssh/id_borg.pub') }}"
          manage_dir: yes
        delegate_to: "{{ backup_server_ip }}"
  
      - name: Initialize Borg repository
        command: |
          borg init --encryption=repokey \
          backuper@{{ backup_server_ip }}:{{ backup_user }}/{{ ansible_hostname }} \
          -e kali
        args:
          creates: "/home/backuper/{{ ansible_hostname }}/config"
        changed_when: false
  
      - name: Create backup script
        copy:
          dest: /home/kali/backup.sh
          mode: 0755
          content: |
            #!/bin/bash
            export BORG_PASSPHRASE='kali'
            borg create --stats backuper@{{ backup_server_ip }}:backuper/$(hostname)::$(date +%Y-%m-%d_%H-%M) \
              /etc /home /var/www \
              --exclude '*.tmp' \
              --exclude '*.cache'
            
            borg prune --keep-daily 7 backuper@{{ backup_server_ip }}:backuper/$(hostname)
  
      - name: Add cron job
        cron:
          name: "Daily Backup"
          job: "/home/kali/backup.sh"
          minute: "0"
          hour: "2"
          user: kali